<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>WebYPSH</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css">
  <style>
    html,body{height:100%;margin:0;background:#111;color:#eee;font-family:ui-monospace,monospace}
    #toolbar{height:48px;display:flex;align-items:center;gap:8px;padding:8px;background:#1a1a1a}
    #term{height:calc(100dvh - 48px)}
    button{padding:6px 10px;border-radius:8px;border:0;background:#2a2a2a;color:#eee}
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="ctrlc">Ctrl-C</button>
  </div>
  <div id="term"></div>
  <script>
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = src; s.async = false;
        s.onload = () => resolve(src);
        s.onerror = () => reject(new Error('Failed to load: ' + src));
        document.head.appendChild(s);
      });
    }

    (async () => {
      await loadScript("https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.js");
      try {
        await loadScript("./v86/libv86.js");
      } catch {
        await loadScript("https://cdn.jsdelivr.net/npm/v86@0.5.253/build/libv86.js");
      }
      if (!('Terminal' in window) || !('V86Starter' in window)) {
        console.error('必要なライブラリが読み込めていません'); return;
      }
      const term = new Terminal({ convertEol: true, cursorBlink: true, fontSize: 14 });
      term.open(document.getElementById('term'));
      const emu = new V86Starter({
        wasm_path: "./v86/v86.wasm",
        memory_size: 512 * 1024 * 1024,
        vga_memory_size: 8 * 1024 * 1024,
        bzimage: { url: "./assets/bzImage" },
        hda:     { url: "./assets/hda.img" },
        cmdline: "console=ttyS0 root=/dev/sda rw init=/bin/bash",
        autostart: true,
      });
      emu.add_listener("serial0-output-char", c => term.write(c));
      term.onData(d => emu.serial0_send(d));
      document.getElementById('ctrlc').onclick = () => emu.serial0_send("\x03");
      emu.add_listener("emulator-ready", () => {
        const cmds = [
          "mount -t proc proc /proc\n",
          "export HOME=/root\n",
          "cd /root\n",
          "python3 /root/ypsh.py\n"
        ];
        const feed = () => setTimeout(() => {
          if (cmds.length) { emu.serial0_send(cmds.shift()); feed(); }
        }, 800);
        feed();
      });
    })();
  </script>
</body>
</html>
