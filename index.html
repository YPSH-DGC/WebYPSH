<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>WebYPSH</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link rel="stylesheet" href="./xterm/xterm.css">
  <style>
    html,body{height:100%;margin:0;background:#111;color:#eee;font-family:ui-monospace,monospace}
    #toolbar{height:48px;display:flex;align-items:center;gap:8px;padding:8px;background:#1a1a1a}
    #term{height:calc(100dvh - 48px)}
    button{padding:6px 10px;border-radius:8px;border:0;background:#2a2a2a;color:#eee}
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="ctrlc">Ctrl-C</button>
  </div>
  <div id="term"></div>

  <script src="./xterm/xterm.js"></script>
  <script src="./v86/libv86.js"></script>
  <script>
    (function start(){
      if(typeof Terminal!=='function'||typeof V86Starter!=='function'){
        return setTimeout(start,50);
      }
      const term = new Terminal({convertEol:true,cursorBlink:true,fontSize:14});
      term.open(document.getElementById('term'));
      const emu = new V86Starter({
        wasm_path: "./v86/v86.wasm",
        memory_size: 512*1024*1024,
        vga_memory_size: 8*1024*1024,
        bzimage: { url: "./assets/bzImage" },
        hda:     { url: "./assets/hda.img" },
        cmdline: "console=ttyS0 root=/dev/sda rw init=/bin/bash",
        autostart: true,
      });
      const dec = new TextDecoder();
      let buf = [];
      function flush(){
        if(buf.length){ term.write(dec.decode(new Uint8Array(buf))); buf.length = 0; }
      }
      emu.add_listener("serial0-output-byte", b => { buf.push(b); if(buf.length>512) flush(); });
      setInterval(flush, 16);
      term.onData(d => emu.serial0_send(d));
      document.getElementById('ctrlc').onclick = () => emu.serial0_send("\x03");
      emu.add_listener("emulator-ready", () => {
        const cmds = [
          "mount -t proc proc /proc\n",
          "export HOME=/root\n",
          "cd /root\n",
          "python3 /root/ypsh.py\n"
        ];
        const feed = () => setTimeout(() => { if(cmds.length){ emu.serial0_send(cmds.shift()); feed(); } }, 800);
        feed();
      });
    })();
  </script>
</body>
</html>
